<!DOCTYPE html>
<html lang="en">
<head>
	<title>Stain Send</title>

	<style>
        @font-face {
            font-family: Whitney;
            font-weight: 500;
            src: url(/Whitney500.woff) format("woff")
        }

        @font-face {
            font-family: Whitney;
            font-weight: 600;
            src: url(/Whitney600.woff) format("woff")
        }

        body {
            font-family: Whitney, sans-serif;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            height: 100vh;
            justify-content: center;
            text-align: center;
            background: #36393f;
            color: white;
        }

        h1 {
            font-weight: 600;
            font-size: 2.5rem;
        }

        br {
            margin-bottom: 1rem;
        }

        a {
            color: #41adff;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
	</style>
</head>
<body>
<header>
	<h1>Stain Send</h1>
	<h2>A basic theme and repo sender for <a href="https://github.com/yellowsink/cc-plugins">Cumstain</a>.</h2>
</header>

<main>
	<!--suppress HtmlFormInputWithoutLabel -->
	<input id="url" type="text" placeholder="Theme / Repo URL"/>
	<br/>
	<span id="status"></span>
	<br/>
	<button onclick="genTheme()">Generate (Theme)</button>
	<button onclick="genRepo()">Generate (Repo)</button>
</main>

<script>
	// DOM CODE
	const urlInput = document.getElementById("url");
	const statusSpan = document.getElementById("status");

	const resetSoon = () => setTimeout(() => (statusSpan.innerText = ""), 5000);

	// GENERATION CODE
	function gen(prepend) {
		const url = new URL(location.href);
		url.hash = prepend + urlInput.value;
		navigator.clipboard.writeText(url.href);
		statusSpan.innerText = "Copied URL to clipboard!";
		resetSoon();
	}

	window.genTheme = () => gen("T_");
	window.genRepo = () => gen("R_");

	// WEBSOCKET CODE
	let lastId = 0;
	const getId = () => lastId++;

	const promisifyWsWithTimeout = (ws, id) => new Promise((res, rej) => {
		ws.onmessage = (ev) => {
			try {
				const parsed = JSON.parse(ev.data);
				if (parsed?.uuid !== id) return;
				res(parsed);
			} catch {
			}
		};
		setTimeout(rej, 5000);
	});

	async function sendToDiscord(msg) {
		const promises = [];
		for (let i = 6463; i <= 6473; i++) {
			// noinspection SpellCheckingInspection
			const ws = new WebSocket("ws://127.0.0.1:" + i + "/cumcord");
			const newMsg = {...msg, uuid: getId()};
			// noinspection JSCheckFunctionSignatures
			ws.onopen = () => {
				ws.send(JSON.stringify(newMsg));
				promises.push(promisifyWsWithTimeout(ws, newMsg.uuid).then(r => [i, r]))
			};
		}

		// give the WS time
		await new Promise((res) => {
			const clear = setInterval(() => {
				if (promises.length > 0) {
					setTimeout(res, 500);
					clearInterval(clear);
				}
			}, 100);
			setTimeout(() => {
				clearInterval(clear);
				res();
			}, 5000);
		})

		return await Promise.all(promises);
	}

	// SENDING CODE
	// iife go BRRR, yes i could just have used type="module" -- sink
	(async () => {
		const isTheme = location.hash.startsWith("#T");
		if (!isTheme && !location.hash.startsWith("#R")) return;

		document.querySelectorAll("button, br").forEach(e => e.remove());
		urlInput.remove();

		statusSpan.innerText = "Talking to Cumcord, please wait..."

		const msg = {
			action: `ysink_stain_add${isTheme ? "theme" : "repo"}`,
			url: isTheme && location.hash.slice(2),
			repo: !isTheme && location.hash.slice(2)
		}

		const res = await sendToDiscord(msg);
		statusSpan.innerText = res.map(([port, msg]) => `[${port}] ${msg?.status}: ${msg?.message}`).join("\n");
	})()
</script>
</body>
</html>